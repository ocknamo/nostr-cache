# ストレージレイヤー設計仕様書

## 1. 概要
本設計書では、cache-relayのストレージレイヤーの実装仕様について記載する。
主にDexie.jsを使用したIndexedDBの実装とテストについて詳述する。

## 2. システム構成

### 2.1. 依存関係
#### 2.1.1. 主要依存パッケージ
- dexie: ^4.0.11（IndexedDBラッパーライブラリ）
- @nostr-cache/shared: ^0.1.0（共有型定義、共有ユーティリティ）

#### 2.1.2. テスト用依存パッケージ
- fake-indexeddb: ^6.0.0（IndexedDBモック）

### 2.2. 基本構成
- 実装ファイル: packages/cache-relay/src/storage/DexieStorage.ts
- データベース: IndexedDB (Dexie.js)
- テーブル構成: events
  - 主要フィールド：id, pubkey, created_at, kind, tags, content, sig
  - インデックス用フィールド：indexed_tags

### 2.3. インターフェース仕様
StorageAdapterインターフェースの実装
- saveEvent(): イベントの保存機能
- getEvents(): フィルタに基づくイベント取得機能
- deleteEvent(): イベント削除機能
- clear(): ストレージクリア機能

## 3. データベース設計

### 3.1. インデックス構成
#### 3.1.1. 単一フィールドインデックス
- id: プライマリキー
- pubkey: 著者検索用
- created_at: 時間範囲検索用
- kind: イベント種別検索用
- indexed_tags: タグ検索用（配列インデックス）

#### 3.1.2. 複合インデックス
- [pubkey+kind]: 著者とイベント種別の組み合わせ検索用
- [kind+created_at]: イベント種別と時間範囲の検索用
- [pubkey+created_at]: 著者と時間範囲の検索用
- [pubkey+kind+created_at]: 複合条件での検索用

### 3.2. タグインデックス仕様
- indexed_tagsフィールドの実装
- 優先タグの定義（e, p, a, t, d, h, m, q, r）
- タグインデックスの制限（最大100個）

## 4. 機能仕様

### 4.1. クエリ処理機能
- フィルタ条件に基づく最適なインデックス選択機能
- 複数フィルタの効率的な処理機能
- タグフィルタと時間範囲フィルタの組み合わせ処理

### 4.2. タグ処理機能
- シングルレタータグの優先処理
- タグ形式の正規化（`{tagName}:{value}`形式）
- 無効なタグ形式の検証と除外

### 4.3. フィルタ処理機能
- since/untilパラメータによる時間範囲フィルタ
- 複合条件での時間範囲フィルタ処理
- タグ値の検証と正規化処理

## 5. テスト仕様

### 5.1. 基本機能テスト
- イベントの保存・取得機能
- イベントの削除機能
- ストレージのクリア機能

### 5.2. フィルタリングテスト
- 単一条件フィルタ（id, author, kind）
- 複合条件フィルタ
- タグフィルタ
- 時間範囲フィルタ

### 5.3. 異常系テスト
- 無効なタグ形式
- インデックス制限
- 優先タグの処理

## 6. パフォーマンス要件

### 6.1. インデックス最適化
- 単一フィールドインデックスの効率的な利用
- 複合インデックスによる検索の高速化
- タグインデックスの効率的な管理

### 6.2. クエリ最適化
- フィルタ条件に基づく最適なインデックス選択
- 複数フィルタの効率的な処理
- タグフィルタと時間範囲フィルタの組み合わせ最適化

## 7. 制限事項
- インデックス化されるタグの数は最大100個
- シングルレターのタグのみがインデックス化される
- 複雑なタグフィルタリングはパフォーマンスに影響を与える可能性あり

## 8. TODO
- タグインデックスの動的な優先順位付け機能
- クエリパフォーマンスのモニタリング機能
- 大規模データセットでのパフォーマンス最適化
- ヘッドレスブラウザを使用したパフォーマンステスト
  - 大量データ投入時のインデックス性能測定
  - 複雑なフィルタ条件での検索性能測定
  - メモリ使用量の監視
